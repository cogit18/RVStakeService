<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood Drive 5/21 Signups</title>
    <style>
        /* Modernized & Tighter Layout - Synced with all stake files */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; color: #333; margin: 8px; line-height: 1.2; font-size: 13px; background-color: #f8fafc; }
        
        .summary-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 10px; background: white; border-radius: 8px; border: 1px solid #e2e8f0; flex-wrap: wrap; gap: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        
        /* Column Layout - Removed Slot Column */
        .signup-row { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #edf2f7; background: white; flex-wrap: wrap; gap: 4px; }
        .signup-header { display: flex; font-weight: bold; padding: 10px; background: #f1f5f9; border-radius: 8px 8px 0 0; border-bottom: 2px solid #cbd5e0; flex-wrap: wrap; }
        
        /* Widths optimized for Desktop - Tighter Ward column */
        .col-date { width: 95px; font-weight: 600; }
        .col-time { width: 140px; color: #475569; }
        .col-ward { width: 80px; color: #64748b; text-align: center; }
        .col-name { flex: 1; min-width: 120px; padding-left: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .col-action { width: 80px; text-align: right; }

        /* Mobile specific adjustments */
        @media (max-width: 500px) {
            .signup-header { display: none; }
            .signup-row { padding: 10px 5px; }
            .col-date { width: 90px; font-size: 12px; }
            .col-time { width: 125px; font-size: 12px; }
            .col-ward { display: none; }
            .col-name { order: 3; width: 60%; flex: none; font-size: 12px; margin-top: 4px; padding-left: 0; }
            .col-action { order: 4; width: 35%; flex: none; margin-top: 4px; }
        }

        /* Buttons & Visuals */
        .btn { padding: 6px 10px; cursor: pointer; border-radius: 6px; border: none; font-size: 12px; font-weight: 600; transition: 0.2s; position: relative; }
        .btn-claim { background: #16a34a; color: white; width: 100%; }
        .btn-clear { background: #ef4444; color: white; width: 100%; }
        
        .spinner { display: none; width: 12px; height: 12px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; position: absolute; left: 50%; top: 50%; margin-left: -6px; margin-top: -6px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading .spinner { display: block; }
        .loading .btn-text { visibility: hidden; }

        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); border-radius: 12px; z-index: 1000; width: 85%; max-width: 320px; border: 1px solid #e2e8f0; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 999; }
        
        input, .filter-select { width: 100%; padding: 8px; margin: 8px 0; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px; box-sizing: border-box; }
        .filter-select { width: auto; min-width: 120px; }
    </style>
</head>
<body>

<div class="summary-header">
    <div id="slot-counter">Connecting...</div>
    <div style="display: flex; align-items: center; gap: 10px;">
        <label style="font-size: 12px; display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="unclaimed-only" onchange="renderSlots()" style="width: auto;"> Only Open Spots
        </label>
        <select id="ward-filter" class="filter-select" onchange="handleFilterChange()">
            <option value="">All Wards</option>
        </select>
    </div>
</div>

<div class="signup-header">
    <div class="col-date">Date</div>
    <div class="col-time">Time</div>
    <div class="col-ward">Ward</div>
    <div class="col-name">Claimed By</div>
    <div class="col-action"></div>
</div>

<div id="signup-container"></div>

<button id="view-more-btn" class="btn" style="display: none; width: 100%; margin-top: 15px; background: #64748b; color: white; padding: 12px;" onclick="loadMore()">Load More</button>

<div class="overlay" id="overlay" onclick="closeAllModals()"></div>

<div class="modal" id="claimModal">
    <h3 style="margin: 0 0 5px 0;">Claim Blood Drive Spot</h3>
    <input type="hidden" id="activeId">
    <input type="text" id="userName" placeholder="Full Name" required>
    <input type="tel" id="userPhone" placeholder="Phone Number" maxlength="14" required>
    <div style="display: flex; gap: 8px; margin-top: 10px;">
        <button class="btn" style="background:#e2e8f0; flex: 1;" onclick="closeAllModals()">Cancel</button>
        <button class="btn btn-claim" id="confirmClaimBtn" style="flex: 2;" onclick="submitClaim()">
            <span class="btn-text">Confirm Claim</span>
            <div class="spinner"></div>
        </button>
    </div>
</div>

<div class="modal" id="clearModal">
    <h3 style="margin: 0 0 10px 0;">Clear Assignment?</h3>
    <p style="font-size: 13px; color: #475569;">Are you sure you want to make this spot available again?</p>
    <input type="hidden" id="clearActiveId">
    <div style="display: flex; gap: 8px; margin-top: 20px;">
        <button class="btn" style="background:#e2e8f0; flex: 1;" onclick="closeAllModals()">Go Back</button>
        <button class="btn btn-clear" id="confirmClearBtn" style="flex: 1;" onclick="submitClear()">
            <span class="btn-text">Yes, Clear</span>
            <div class="spinner"></div>
        </button>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyDt8fvW7hZ-5rlORLTX9S73uO3_WP1dJD8OdmgAXee9l5BJsBTTPj3V_kbaG8kjc5fcQ/exec";
    const API_KEY = ""; 
    const DATA_SHEET = "BloodDrive5/21";
    
    let allData = [];
    let displayedCount = 25;
    let currentWardFilter = "";

    function formatTime(val) {
        if (!val || typeof val !== 'string' || !val.includes('T')) return val;
        try {
            const date = new Date(val);
            if (isNaN(date.getTime())) return val;
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        } catch (e) { return val; }
    }

    document.getElementById('userPhone').addEventListener('input', e => {
        let x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
        e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
    });

    async function loadSignups() {
        try {
            const response = await fetch(`${API_URL}?key=${API_KEY}&sheet=${DATA_SHEET}`);
            const result = await response.json();
            if (result.status !== 200) throw new Error();

            const today = new Date();
            today.setHours(0,0,0,0);

            allData = result.data
                .filter(row => {
                    const rowDate = new Date(row.Date);
                    return row.Date && !isNaN(rowDate.getTime()) && rowDate >= today;
                })
                .sort((a, b) => new Date(a.Date) - new Date(b.Date));

            populateWardFilter();
            renderSlots();
        } catch (e) {
            document.getElementById('signup-container').innerHTML = "<div style='padding:20px; text-align:center;'>Unable to load data. Please refresh.</div>";
        }
    }

    function populateWardFilter() {
        const filter = document.getElementById('ward-filter');
        const wards = [...new Set(allData.map(row => (row.Ward || "").trim()))].filter(w => w !== "").sort();
        filter.innerHTML = '<option value="">All Wards</option>';
        wards.forEach(ward => {
            const opt = document.createElement('option');
            opt.value = ward; opt.textContent = ward;
            filter.appendChild(opt);
        });
    }

    function handleFilterChange() {
        currentWardFilter = document.getElementById('ward-filter').value;
        renderSlots();
    }

    function renderSlots() {
        const container = document.getElementById('signup-container');
        const showUnclaimedOnly = document.getElementById('unclaimed-only').checked;
        container.innerHTML = '';
        
        let filteredData = allData.filter(row => {
            const matchesWard = !currentWardFilter || (row.Ward || "").trim() === currentWardFilter;
            const matchesOpen = !showUnclaimedOnly || !(row.Name || "").toString().trim();
            return matchesWard && matchesOpen;
        });

        document.getElementById('slot-counter').innerHTML = `<b>${filteredData.filter(r => !(r.Name || "").trim()).length}</b> Blood Drive Spots Open`;

        filteredData.slice(0, displayedCount).forEach(row => {
            const div = document.createElement('div');
            div.className = 'signup-row';
            const isClaimed = (row.Name || "").toString().trim() !== "";
            const rowDate = new Date(row.Date);
            rowDate.setHours(rowDate.getHours() + 5); 
            
            const dateStr = rowDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            const startTime = formatTime(row['Start Time'] || row['StartTime'] || '---');

            div.innerHTML = `
                <div class="col-date">${dateStr}</div>
                <div class="col-time">${startTime}</div>
                <div class="col-ward">${row.Ward || '-'}</div>
                <div class="col-name">${isClaimed ? `<b>${row.Name}</b>` : '<span style="color:#cbd5e0;">Available</span>'}</div>
                <div class="col-action">
                    ${isClaimed ? 
                        `<button class="btn btn-clear" onclick="openClearModal(${row._id})">Clear</button>` : 
                        `<button class="btn btn-claim" onclick="openClaimModal(${row._id})">Claim</button>`
                    }
                </div>
            `;
            container.appendChild(div);
        });

        document.getElementById('view-more-btn').style.display = filteredData.length > displayedCount ? 'block' : 'none';
    }

    function loadMore() { displayedCount += 25; renderSlots(); }
    
    function openClaimModal(id) { 
        document.getElementById('activeId').value = id; 
        document.getElementById('claimModal').style.display = 'block'; 
        document.getElementById('overlay').style.display = 'block'; 
    }

    function openClearModal(id) {
        document.getElementById('clearActiveId').value = id;
        document.getElementById('clearModal').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    function closeAllModals() { 
        document.querySelectorAll('.modal, .overlay').forEach(el => el.style.display = 'none'); 
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('loading'));
    }

    async function submitClaim() {
        const id = document.getElementById('activeId').value;
        const name = document.getElementById('userName').value.trim();
        const phone = document.getElementById('userPhone').value.replace(/\D/g, '');
        if(!name || phone.length < 10 ) return alert("Please enter name and phone.");

        const btn = document.getElementById('confirmClaimBtn');
        btn.classList.add('loading');
        
        // Optimistic UI update
        const index = allData.findIndex(item => item._id == id);
        if (index !== -1) {
            allData[index].Name = name;
            allData[index].Phone = phone;
        }

        try {
            fetch(API_URL, { 
                method: 'POST', 
                mode: 'no-cors',
                body: JSON.stringify({ method: 'PUT', key: API_KEY, sheet: DATA_SHEET, id: id, payload: { Name: name, Phone: phone } }) 
            });
            setTimeout(() => { closeAllModals(); renderSlots(); }, 500);
        } catch (e) { closeAllModals(); }
    }

    async function submitClear() {
        const id = document.getElementById('clearActiveId').value;
        const btn = document.getElementById('confirmClearBtn');
        btn.classList.add('loading');
        
        // Optimistic UI update
        const index = allData.findIndex(item => item._id == id);
        if (index !== -1) {
            allData[index].Name = "";
            allData[index].Phone = "";
        }

        try {
            fetch(API_URL, { 
                method: 'POST', 
                mode: 'no-cors',
                body: JSON.stringify({ method: 'PUT', key: API_KEY, sheet: DATA_SHEET, id: id, payload: { Name: "", Phone: "" } }) 
            });
            setTimeout(() => { closeAllModals(); renderSlots(); }, 500);
        } catch (e) { closeAllModals(); }
    }

    loadSignups();
</script>
</body>
</html>