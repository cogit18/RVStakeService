<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temple Signups</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; color: #333; margin: 20px; line-height: 1.5; }
        
        /* Header and Summary */
        .summary-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: #f0f4f8; border-radius: 8px; border: 1px solid #d1d9e6; flex-wrap: wrap; gap: 10px; }
        .signup-header { display: flex; font-weight: bold; padding: 12px; background: #e2e8f0; border-radius: 6px 6px 0 0; border-bottom: 2px solid #cbd5e0; }
        
        /* Grid and Rows */
        .signup-row { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #edf2f7; transition: background 0.2s; }
        .signup-row:nth-child(even) { background-color: #f8fafc; }
        .signup-row:hover { background-color: #f1f5f9; }

        /* Column Layout */
        .col-date { width: 130px; flex-shrink: 0; }
        .col-time { width: 210px; flex-shrink: 0; font-weight: 500; }
        .col-ward { width: 140px; flex-shrink: 0; }
        .col-slot { width: 60px; flex-shrink: 0; text-align: center; }
        .col-name { flex-grow: 1; padding: 0 10px; }
        .col-action { width: 120px; text-align: right; flex-shrink: 0; }
        
        /* Buttons & Inputs */
        .btn { padding: 8px 16px; cursor: pointer; border-radius: 6px; border: none; font-size: 14px; font-weight: 500; transition: 0.2s; position: relative; min-width: 80px; }
        .btn-claim { background: #16a34a; color: white; }
        .btn-claim:hover { background: #15803d; }
        .btn-clear { background: #dc2626; color: white; }
        .btn-clear:hover { background: #b91c1c; }
        .btn-more { display: block; width: 100%; padding: 14px; margin-top: 20px; background: #475569; color: white; border-radius: 8px; font-size: 16px; }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
        
        /* Spinner Styles */
        .spinner {
            display: none;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s linear infinite;
            position: absolute;
            left: 50%;
            top: 50%;
            margin-left: -7px;
            margin-top: -7px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading .spinner { display: block; }
        .loading .btn-text { visibility: hidden; }

        .filter-select { padding: 8px; border-radius: 6px; border: 1px solid #cbd5e0; font-size: 14px; background: white; min-width: 150px; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                 background: white; padding: 30px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); 
                 border-radius: 12px; z-index: 100; width: 340px; border: 1px solid #e2e8f0; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); z-index: 50; }
        
        input, .modal select { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px; box-sizing: border-box; }
        
        @media (max-width: 768px) {
            .col-ward, .col-slot { display: none; }
            .col-time { width: 170px; }
        }
    </style>
</head>
<body>

<div class="summary-header">
    <div id="slot-counter" style="font-weight: bold; font-size: 1.1em;">Connecting...</div>
    <div>
        <label for="ward-filter" style="font-size: 14px; font-weight: 500; margin-right: 8px;">Filter by Ward:</label>
        <select id="ward-filter" class="filter-select" onchange="handleFilterChange()">
            <option value="">All Wards</option>
        </select>
    </div>
</div>

<div class="signup-header">
    <div class="col-date">Day & Date</div>
    <div class="col-time">Time (Mountain)</div>
    <div class="col-ward">Ward</div>
    <div class="col-slot">Slot</div>
    <div class="col-name">Claimed By</div>
    <div class="col-action"></div>
</div>

<div id="signup-container" style="min-height: 200px;">
    <div style="padding: 40px; text-align: center; color: #64748b;">Loading upcoming signups...</div>
</div>

<button id="view-more-btn" class="btn btn-more" style="display: none;" onclick="loadMore()">Load More Spots</button>

<div class="overlay" id="overlay" onclick="closeModal()"></div>
<div class="modal" id="claimModal">
    <h3 style="margin-top:0;">Claim Spot</h3>
    <input type="hidden" id="activeId">
    <label style="font-size: 12px; color: #64748b;">Your Name</label>
    <input type="text" id="userName" placeholder="First and Last Name" required>
    
    <label style="font-size: 12px; color: #64748b;">Phone Number</label>
    <input type="tel" id="userPhone" placeholder="(###) ###-####" maxlength="14" required>
    
    <label style="font-size: 12px; color: #64748b;">Carrier</label>
    <select id="userProvider" required>
        <option value="">Select Carrier</option>
        <option value="AT&T">AT&T</option>
        <option value="T-Mobile">T-Mobile</option>
        <option value="Verizon">Verizon</option>
        <option value="Sprint">Sprint</option>
        <option value="Xfinity Mobile">Xfinity Mobile</option>
        <option value="Mint Mobile">Mint Mobile</option>
        <option value="Google Fi">Google Fi</option>
    </select>
    
    <div style="margin-top:20px; display: flex; gap: 10px;">
        <button class="btn" style="background:#f1f5f9; flex: 1;" onclick="closeModal()">Cancel</button>
        <button class="btn btn-claim" id="confirmClaimBtn" style="flex: 2;" onclick="submitClaim()">
            <span class="btn-text">Confirm Claim</span>
            <div class="spinner"></div>
        </button>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycby1U4WuVfsAcWK-3qcFsZwMsZIRw_mxAR7TGilLtN1oIhp65qElFHD4Lj6dOhwozZ2M/exec";
    const API_KEY = ""; 
    const DATA_SHEET = "Temple";
    
    let allData = [];
    let displayedCount = 20;
    let currentWardFilter = "";

    // Automatic Phone Formatting
    document.getElementById('userPhone').addEventListener('input', function (e) {
        let x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
        e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
    });

    function formatTime(timeVal, isMonday, isEndTime) {
        if (!timeVal) return '---';
        if (isMonday) {
            return isEndTime ? "12:00 PM" : "9:45 AM";
        } else {
            return isEndTime ? "12:00 AM" : "9:45 PM";
        }
    }

    async function loadSignups() {
        try {
            const response = await fetch(`${API_URL}?key=${API_KEY}&sheet=${DATA_SHEET}`);
            const result = await response.json();
            
            if (result.status !== 200) {
                document.getElementById('signup-container').innerHTML = "Error loading data.";
                return;
            }

            const today = new Date();
            today.setHours(0,0,0,0);

            allData = result.data
                .filter(row => {
                    const rowDate = new Date(row.Date);
                    return row.Date && !isNaN(rowDate.getTime()) && rowDate >= today;
                })
                .sort((a, b) => new Date(a.Date) - new Date(b.Date));

            populateWardFilter();
            renderSlots();
        } catch (e) {
            document.getElementById('signup-container').innerHTML = "Connection Error.";
        }
    }

    function populateWardFilter() {
        const filter = document.getElementById('ward-filter');
        const wards = [...new Set(allData.map(row => (row.Ward || row.ward || "").trim()))].filter(w => w !== "");
        wards.sort();
        
        filter.innerHTML = '<option value="">All Wards</option>';
        wards.forEach(ward => {
            const opt = document.createElement('option');
            opt.value = ward;
            opt.textContent = ward;
            filter.appendChild(opt);
        });
        filter.value = currentWardFilter;
    }

    function handleFilterChange() {
        currentWardFilter = document.getElementById('ward-filter').value;
        displayedCount = 20; 
        renderSlots();
    }

    function renderSlots() {
        const container = document.getElementById('signup-container');
        container.innerHTML = '';
        
        const filteredData = currentWardFilter 
            ? allData.filter(row => (row.Ward || row.ward || "").trim() === currentWardFilter)
            : allData;

        const openCount = filteredData.filter(row => !(row.Name || "").toString().trim()).length;
        document.getElementById('slot-counter').textContent = `Open Assignments: ${openCount}`;

        const subset = filteredData.slice(0, displayedCount);
        if (subset.length === 0) {
            container.innerHTML = `<div style="padding:40px; text-align:center;">No upcoming assignments found.</div>`;
        }

        subset.forEach(row => {
            const div = document.createElement('div');
            div.className = 'signup-row';
            const isClaimed = (row.Name || "").toString().trim() !== "";
            
            const rowDate = new Date(row.Date);
            rowDate.setHours(rowDate.getHours() + 5);
            const isMonday = rowDate.getDay() === 1;

            const dateString = rowDate.toLocaleDateString('en-US', {
                timeZone: 'America/Denver', 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric'
            });

            const startTime = formatTime(row['Start Time'] || row['StartTime'], isMonday, false);
            const endTime = formatTime(row['End Time'] || row['EndTime'], isMonday, true);

            div.innerHTML = `
                <div class="col-date">${dateString}</div>
                <div class="col-time">${startTime} - ${endTime}</div>
                <div class="col-ward">${row.Ward || row.ward || '---'}</div>
                <div class="col-slot">${row.Slot || '-'}</div>
                <div class="col-name">${isClaimed ? `<strong>${row.Name}</strong>` : '<span style="color:#94a3b8; font-style:italic;">Available</span>'}</div>
                <div class="col-action">
                    ${isClaimed ? 
                        `<button class="btn btn-clear" onclick="clearSpot(this, ${row._id})"><span class="btn-text">Clear</span><div class="spinner"></div></button>` : 
                        `<button class="btn btn-claim" onclick="openModal(${row._id})">Claim</button>`
                    }
                </div>
            `;
            container.appendChild(div);
        });

        const moreBtn = document.getElementById('view-more-btn');
        moreBtn.style.display = filteredData.length > displayedCount ? 'block' : 'none';
    }

    function loadMore() {
        displayedCount += 30;
        renderSlots();
    }

    function openModal(id) {
        document.getElementById('activeId').value = id;
        document.getElementById('userName').value = "";
        document.getElementById('userPhone').value = "";
        document.getElementById('userProvider').value = "";
        document.getElementById('claimModal').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('claimModal').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('confirmClaimBtn').classList.remove('loading');
        document.getElementById('confirmClaimBtn').disabled = false;
    }

    async function submitClaim() {
        const id = document.getElementById('activeId').value;
        const name = document.getElementById('userName').value.trim();
        const phone = document.getElementById('userPhone').value.replace(/\D/g, '');
        const provider = document.getElementById('userProvider').value;
        const btn = document.getElementById('confirmClaimBtn');

        if(!name || phone.length < 10 || !provider) return alert("Fill all fields.");

        btn.classList.add('loading');
        btn.disabled = true;

        try {
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ method: 'PUT', key: API_KEY, sheet: DATA_SHEET, id: id, payload: { Name: name, Phone: phone, Provider: provider } })
            });
            closeModal();
            loadSignups();
        } catch (e) {
            alert("Error claiming spot. Please try again.");
            btn.classList.remove('loading');
            btn.disabled = false;
        }
    }

    async function clearSpot(btn, id) {
        if (!confirm("Make this spot available?")) return;
        
        btn.classList.add('loading');
        btn.disabled = true;

        try {
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ method: 'PUT', key: API_KEY, sheet: DATA_SHEET, id: id, payload: { Name: "", Phone: "", Provider: "" } })
            });
            loadSignups();
        } catch (e) {
            alert("Error clearing spot.");
            btn.classList.remove('loading');
            btn.disabled = false;
        }
    }

    loadSignups();
</script>
</body>
</html>